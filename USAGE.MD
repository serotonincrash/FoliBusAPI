# FoliBusAPI Usage Guide

FoliBusAPI is a Swift library for accessing real-time public transport data from the Foli (Föli) API, which serves the Turku region of Finland. The library provides async/await networking, SwiftUI property wrappers for reactive data binding, and comprehensive data models.

## Disclaimer

Docs are generated by z.ai GLM 4.7 and are a work in progress (manual cleanup of the docs).

## Requirements

- iOS 15.0+, macOS 12.0+, watchOS 8.0+, tvOS 15.0+
- Xcode 14.0+

## Overview

The library is organized into three main components:

1. **Data Models** (`FoliModels.swift`) - Codable types representing API responses
2. **Client** (`FoliClient.swift`) - Async actor for making API requests
3. **Property Wrappers** (`FoliPropertyWrappers.swift`) - SwiftUI reactive data bindings

## Quick Start

### Using the Static Convenience API

For simple use cases, use the static methods on `FoliBusAPI`:

```swift
import FoliBusAPI

// Fetch arrivals for a stop
let arrivals = try await FoliBusAPI.fetchArrivals(for: "4")

// Fetch all stops
let stops = try await FoliBusAPI.fetchStops()
```

### Using the FoliClient Directly

For more control, use the Foli​Client actor:
```swift
import FoliBusAPI

let client = FoliClient.shared

// Fetch stop monitoring response
let response = try await client.fetchStopMonitoring(for: "4")
if response.isValid {
    print("Server time: \(response.serverDate)")
    for arrival in response.result {
        print("\(arrival.lineRef): \(arrival.formattedTimeUntilArrival())")
    }
}

// Fetch arrivals only
let arrivals = try await client.fetchArrivals(for: 4) // accepts Int or String

// Fetch complete stop list
let stops = try await client.fetchStopList()
```

## Data Models

### Foli Namespace

All Foli data models are nested under the Foli enum namespace.

### Foli.Stop

Represents a single transport stop.
```swift
public struct Stop: Codable, Sendable {
    public let stopName: String
}
```
**Example:**
```swift
let stop = Foli.Stop(stopName: "Central Station")
print(stop.stopName) // "Central Station"
```
### FoliStopList

Response containing all known stops as a dictionary mapping stop IDs to stop information.
```swift
public struct FoliStopList: Codable {
    public let stops: [Foli.Stop]
}
```

**Example:**
```swift
let stopList = try await client.fetchStops()
for (stopId, stop) in stopList.stops {
    print("Stop \(stopId): \(stop.stopName)")
}
```

### FoliStopMonitoringResponse

Response from the stop monitoring endpoint containing arrival/departure data.
```swift
let response = try await client.fetchStopMonitoring(for: "4")

if response.isValid {
    print("Data fetched at: \(response.serverDate)")
    print("Number of arrivals: \(response.result.count)")
} else {
    print("Status: \(response.status)")
}
```

### FoliVehicleArrival

Detailed information about a vehicle arrival or departure. Conforms to Identifiable for use in SwiftUI lists.

```swift
public struct FoliVehicleArrival: Codable, Sendable, Identifiable {
    public let id: UUID
    
    public let recordedAtTime: TimeInterval
    public let lineRef: String
    public let monitored: Bool
    public let latitude: Double?
    public let longitude: Double?
    public let originAimedDepartureTime: TimeInterval
    public let destinationAimedArrivalTime: TimeInterval
    public let destinationDisplay: String
    public let aimedArrivalTime: TimeInterval
    public let expectedArrivalTime: TimeInterval
    public let aimedDepartureTime: TimeInterval
    public let expectedDepartureTime: TimeInterval
    public let delay: Int?
}
```

### Computed Properties

`Foli​Vehicle​Arrival` provides several convenience computed properties:

| Property | Type | Description |
|----------|------|-------------|
| recorded​Date | Date | Recorded time as Date |
| aimed​Arrival​Date | Date | Aimed arrival as Date |
| expected​Arrival​Date | Date | Expected arrival as Date |
| aimed​Departure​Date | Date | Aimed departure as Date |
| expected​Departure​Date | Date | Expected departure as Date |
| arrival​Delay | Time​Interval | Delay in seconds (calculated) |
| is​Late | Bool | Vehicle is late (positive delay) |
| is​Early | Bool | Vehicle is early (negative delay) |
| is​On​Time | Bool | Vehicle is on time |
| location | CLLocation​Coordinate2​D? | Vehicle coordinates if available |

Methods

| Method | Description |
|--------|-------------|
| time​Until​Arrival(from:) | Returns seconds until arrival |
| formatted​Time​Until​Arrival(from:) | Returns formatted string (e.g., "5 min", "Due") |

Example:

```swift
for arrival in arrivals {
    print("Line \(arrival.lineRef) to \(arrival.destinationDisplay)")
    print("  Arriving in: \(arrival.formattedTimeUntilArrival())")
    print("  Status: \(arrival.isLate ? "Late" : arrival.isEarly ? "Early" : "On time")")
    
    if let location = arrival.location {
        print("  Location: \(location.latitude), \(location.longitude)")
    }
}
```

## Error Handling

###FoliAPIError

Error types thrown by the API client.

**Example:**
```swift
do {
    let arrivals = try await client.fetchArrivals(for: "999")
} catch let error as FoliAPIError {
    print("API Error: \(error.localizedDescription)")
    switch error {
    case .serverError(let message):
        print("Server message: \(message)")
    case .networkError(let underlyingError):
        print("Network issue: \(underlyingError)")
    default:
        break
    }
}
```

## Property Wrappers

### @FoliStop

A property wrapper that fetches and holds vehicle arrival data for a specific stop with automatic SwiftUI updates.

Basic Usage
```swift
import SwiftUI
import FoliBusAPI

struct StopView: View {
    @FoliStop(id: "4") var arrivals
    @FoliStop(id: 4) var arrivalsNumeric  // Also accepts Int
    
    var body: some View {
        List(arrivals) { arrival in
            VStack(alignment: .leading) {
                Text("Line \(arrival.lineRef)")
                    .font(.headline)
                Text(arrival.destinationDisplay)
                Text(arrival.formattedTimeUntilArrival())
                    .foregroundStyle(.secondary)
            }
        }
    }
}
```
**Using Projected Value**

Access loading state, errors, and manual refresh:
```swift
struct StopView: View {
    @FoliStop(id: "4") var arrivals
    
    var body: some View {
        Group {
            if $arrivals.isLoading {
                ProgressView("Loading arrivals...")
            } else if let error = $arrivals.error {
                Text("Error: \(error.localizedDescription)")
                    .foregroundStyle(.red)
                Button("Retry") {
                    $arrivals.refresh()
                }
            } else {
                List(arrivals) { arrival in
                    ArrivalRow(arrival: arrival)
                }
            }
        }
    }
}
```

Auto-Refresh

Set a refresh interval to automatically update data:
```swift
struct LiveStopView: View {
    @FoliStop(id: "4", refreshInterval: 30) var arrivals
    
    var body: some View {
        List(arrivals) { arrival in
            Text("\(arrival.lineRef): \(arrival.formattedTimeUntilArrival())")
        }
    }
    .onAppear {
        $arrivals.startAutoRefresh()
    }
    .onDisappear {
        $arrivals.stopAutoRefresh()
    }
}
```

### FoliStopProjection

| Property | Type | Description |
|----------|------|-------------|
| arrivals | Binding<[​Foli​Vehicle​Arrival]> | Binding to arrivals array |
| is​Loading | Binding​<​Bool> | Binding to loading state |
| error | Binding​<​Foli​APIError?> | Binding to error state |
| refresh | @​Sendable () -> ​Void | Function to refresh data |
| stop​Id | String | The monitored stop ID |

### @FoliStops

A property wrapper that fetches and holds the complete list of all stops.

Basic Usage
```
struct StopsView: View {
    @FoliStops var stops
    
    var body: some View {
        List(stops) { stop in
            Text("\(stop.id): \(stop.stopName)")
        }
    }
}
```

**Using Projected Value with Helper Methods**
```swift
struct SearchableStopsView: View {
    @FoliStops var stops
    @State private var searchText = ""
    
    var body: some View {
        NavigationView {
            Group {
                if $stops.isLoading {
                    ProgressView("Loading stops...")
                } else if let error = $stops.error {
                    Text("Error: \(error.localizedDescription)")
                    Button("Retry") { $stops.refresh() }
                } else {
                        List($stops.search(query: searchText)) { stop in
                        Text(stop.stopName)
                    }
                }
            }
            .searchable(text: $searchText)
        }
        .onAppear {
            $stops.refresh()
        }
    }
}```

### FoliStopsProjection Properties

| Property | Type | Description |
|----------|------|-------------|
| stops | Binding<[​String: ​Foli​.​Stop]> | Binding to stops dictionary |
| is​Loading | Binding​<​Bool> | Binding to loading state |
| error | Binding​<​Foli​APIError?> | Binding to error state |
| refresh | @​Sendable () -> ​Void | Function to refresh data |
| sorted​Stops | [​Foli​.​Stop]  | Stops sorted by name |
| sorted​By​Id | [​Foli​.​Stop] | NEW: Stops sorted by ID |

### FoliStopsProjection Methods

| Method | Description |
|--------|-------------|
| search(query:) | Search stops by name or ID, returns sorted array |

## Advanced Usage

### Custom URLSession

Inject a custom URLSession for testing or custom configuration:
```swift
let config = URLSessionConfiguration.default
config.timeoutIntervalForRequest = 30
let customSession = URLSession(configuration: config)

let client = FoliClient(session: customSession)
let arrivals = try await client.fetchArrivals(for: "4")```

## API Endpoints

The FoliClient interacts with the following endpoints:

| Endpoint | Method | Returns |
|----------|--------|---------|
| /sm | GET | Complete stop list (`Foli​Stop​List`) |
| /sm/{stop​Id} | GET | Stop monitoring data (`Foli​Stop​Monitoring​Response`) |

Base URL: https://data​.foli​.fi​/siri

## Platform Support

This library supports:
• iOS 15.0+
• macOS 12.0+
• watchOS 8.0+
• tvOS 15.0+
